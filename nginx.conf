# --- Load Balancing Configuration (for multiple backend instances) ---
# upstream fastapi_backend {
#     server 172.31.10.10:8000; # Private IP of EC2 Instance 1 for FastAPI
#     server 172.31.10.11:8000; # Private IP of EC2 Instance 2 for FastAPI
#     least_conn;
# }

# upstream django_admin_backend {
#     server 172.31.10.10:8001; # Private IP of EC2 Instance 1 for Django Admin
#     server 172.31.10.11:8001; # Private IP of EC2 Instance 2 for Django Admin
#     least_conn;
# }
# ------------------------------------------------------------------

server {
    listen 80;
    listen [::]:80;
    server_name your_domain.com www.your_domain.com; # REPLACE WITH YOUR DOMAIN

    location / {
        # For single-instance deployment, proxy directly to local FastAPI port.
        # For multi-instance load balancing, use: proxy_pass http://fastapi_backend;
        proxy_pass http://127.0.0.1:8000; # Your FastAPI app's Gunicorn port
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # Proxy to Django Admin
    location /admin/ {
        # For single-instance deployment, proxy directly to local Django Admin port.
        # For multi-instance load balancing, use: proxy_pass http://django_admin_backend;
        proxy_pass http://127.0.0.1:8001; # Your Django app's Gunicorn port
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # Serve FastAPI's static files directly through Nginx
    location /static/ {
        # Similar to /static/, this path needs to be accessible by the Nginx instance.
        alias /home/ubuntu/Development/MetalWorkers/metalworkers-api/static/; # Adjust this path on the Nginx server
        expires 30d;
        add_header Cache-Control "public, no-transform";
    }

    # For Certbot (Let's Encrypt) challenges
    location ~ /\.well-known/acme-challenge {
        allow all;
        root /var/www/html;
    }
} 